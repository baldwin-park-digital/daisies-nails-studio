---
// No props needed
---
<script>
  // Helper to get all data-* attributes as an object
  function getDataAttributes(element: HTMLElement) {
    const data: Record<string, string> = {};
    if (element && element.dataset) {
      for (const key in element.dataset) {
        data[key] = element.dataset[key] as string;
      }
    }
    return data;
  }

  // Get page context
  function getPageName() {
    const path = window.location.pathname;
    return path === '/' || path === '' ? 'home page' : path;
  }

  // Check consent
  function getCookie(name?: string) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) {
      const part = parts.pop();
      if (part !== undefined) {
        return part.split(';').shift();
      }
    }
    return null;
  }

  function hasAnalyticsConsent() {
    return getCookie('daisies_analytics_consent') === 'yes';
  }

  // Send page view event on initial load if consented
  function sendPageViewEvent() {
    if (!hasAnalyticsConsent()) return;
    const eventData = {
      event: 'page_view',
      event_category: 'impression',
      event_label: getPageName(),
      page_location: window.location.href,
      page_path: getPageName(),
      timestamp: Date.now(),
    };
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push(eventData);
    console.log('[Analytics Sent] Page view:', eventData);
  }


  // Fire page view event when script loads
  sendPageViewEvent();

  // Scroll depth tracking
  const scrollThresholds = [0.25, 0.5, 0.75, 0.9];
  let scrollFired: Record<number, boolean> = {};

  function sendScrollEvent(percent: number) {
    if (!hasAnalyticsConsent()) return;
    const eventData = {
      event: 'scroll',
      event_category: 'engagement',
      event_label: `${Math.round(percent * 100)}%`,
      event_action: 'scroll_depth',
      page_location: window.location.href,
      page_path: getPageName(),
      scroll_percent: percent,
      timestamp: Date.now(),
    };
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push(eventData);
    console.log('[Analytics Sent] Scroll:', eventData);
  }

  function handleScroll() {
    const scrollTop = window.scrollY || document.documentElement.scrollTop;
    const docHeight = Math.max(
      document.documentElement.scrollHeight,
      document.body.scrollHeight
    );
    const winHeight = window.innerHeight;
    const scrolled = (scrollTop + winHeight) / docHeight;
    scrollThresholds.forEach((threshold) => {
      if (scrolled >= threshold && !scrollFired[threshold]) {
        scrollFired[threshold] = true;
        sendScrollEvent(threshold);
      }
    });
  }

  window.addEventListener('scroll', handleScroll);

  // Listen for consent changes to enable analytics immediately
  window.addEventListener('analyticsConsentChanged', () => {
    if (hasAnalyticsConsent()) {
      sendPageViewEvent();
    }
  });

  document.addEventListener('click', function(event) {
    if (!hasAnalyticsConsent()) return;
    let anchor: HTMLAnchorElement | null = null;
    if (event.target instanceof Element) {
      anchor = event.target.closest('a[data-element]');
    }
    if (anchor) {
        const eventData = {
          event: 'click',
          event_category: 'link',
          event_label: anchor.textContent?.trim() || anchor.href,
          event_action: 'link_click',
          page_location: window.location.href,
          page_path: getPageName(),
          href: anchor.href,
          dataAttributes: getDataAttributes(anchor),
          element: dataAttrs.element || null,
          element_detail: anchor.getAttribute('data-element'),
          element_label: anchor.textContent?.trim() || anchor.href
        };
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push(eventData);
      console.log('[Analytics Sent] Link clicked:', eventData);
      return;
    }
    let button: HTMLButtonElement | null = null;
    if (event.target instanceof Element) {
      button = event.target.closest('button[data-element]');
    }
    if (button) {
      // Only send event for accordion-toggle if not already expanded
      if (button.getAttribute('data-element') === 'accordion-toggle' && button.getAttribute('aria-expanded') !== 'true') {
        return;
      }
      const eventData = {
        event: 'click',
        event_category: 'button',
        event_label: button.textContent?.trim(),
        event_action: 'button_click',
        page_location: window.location.href,
        page_path: getPageName(),
        dataAttributes: getDataAttributes(button),
        element_detail: button.getAttribute('data-element'),
        element_label: button.textContent?.trim()
      };
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push(eventData);
      console.log('[Analytics Sent] Button clicked:', eventData);
    }
  });
</script>
