---
// No props needed
---
<script>
  // Helper to get all data-* attributes as an object
  function getDataAttributes(element: HTMLElement) {
    const data: Record<string, string> = {};
    if (element && element.dataset) {
      for (const key in element.dataset) {
        data[key] = element.dataset[key] as string;
      }
    }
    return data;
  }

  // Get page context
  function getPageName() {
    const path = window.location.pathname;
    return path === '/' || path === '' ? 'home page' : path;
  }

  // Check consent
  function getCookie(name?: string) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) {
      const part = parts.pop();
      if (part !== undefined) {
        return part.split(';').shift();
      }
    }
    return null;
  }

  function hasAnalyticsConsent() {
    return getCookie('daisies_analytics_consent') === 'yes';
  }

  // Send page view event on initial load if consented
  function sendPageViewEvent() {
    if (!hasAnalyticsConsent()) return;
    const eventData = {
      event: 'page_view',
      page: getPageName(),
      timestamp: Date.now(),
    };
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push(eventData);
    console.log('[Analytics Sent] Page view:', eventData);
  }

  // Fire page view event when script loads
  sendPageViewEvent();

  // Listen for consent changes to enable analytics immediately
  window.addEventListener('analyticsConsentChanged', () => {
    if (hasAnalyticsConsent()) {
      sendPageViewEvent();
    }
  });

  document.addEventListener('click', function(event) {
    if (!hasAnalyticsConsent()) return;
    let anchor: HTMLAnchorElement | null = null;
    if (event.target instanceof Element) {
      anchor = event.target.closest('a[data-element]');
    }
    if (anchor) {
      const eventData = {
        event: 'link_click',
        href: anchor.href,
        text: anchor.textContent?.trim(),
        page: getPageName(),
        dataAttributes: getDataAttributes(anchor),
        elementDetail: anchor.getAttribute('data-element')
      };
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push(eventData);
      console.log('[Analytics Sent] Link clicked:', eventData);
      return;
    }
    let button: HTMLButtonElement | null = null;
    if (event.target instanceof Element) {
      button = event.target.closest('button[data-element]');
    }
    if (button) {
      // Only send event for accordion-toggle if not already expanded
      if (button.getAttribute('data-element') === 'accordion-toggle' && button.getAttribute('aria-expanded') !== 'true') {
        return;
      }
      const eventData = {
        event: 'button_click',
        text: button.textContent?.trim(),
        page: getPageName(),
        dataAttributes: getDataAttributes(button),
        elementDetail: button.getAttribute('data-element')
      };
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push(eventData);
      console.log('[Analytics Sent] Button clicked:', eventData);
    }
  });
</script>
