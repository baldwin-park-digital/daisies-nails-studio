---
import { galleryImages } from "../data/gallery";
import type { GalleryImage } from "../data/gallery";

interface Props {
  title?: string;
  description?: string;
  images?: GalleryImage[];
  columns?: "2" | "3" | "4";
  showCategories?: boolean;
  variant?: "default" | "highlight";
  layout?: "grid" | "bento";
}

const {
  title = "Gallery",
  description,
  images = galleryImages,
  columns = "3",
  showCategories = false,
  variant = "default",
  layout = "grid",
} = Astro.props;

const columnClasses = {
  "2": "md:grid-cols-2",
  "3": "md:grid-cols-2 lg:grid-cols-3",
  "4": "md:grid-cols-2 lg:grid-cols-4",
};

const variantClasses = {
  default: "bg-transparent",
  highlight: "bg-surface-dim rounded-lg p-8 md:p-6",
};

// Get unique categories if showing category filter
const categories = showCategories
  ? Array.from(new Set(images.map((img) => img.category).filter(Boolean)))
  : [];
---

<section class={`py-16 md:py-12 ${variantClasses[variant]}`}>
  <div class="max-w-7xl mx-auto px-6 md:px-2">
    {title && (
      <div class="mb-12 text-center">
        <h2 class="text-4xl md:text-3xl font-bold text-primary mb-4">
          {title}
        </h2>
        {description && (
          <p class="text-lg text-on-surface-dim max-w-2xl mx-auto">
            {description}
          </p>
        )}
      </div>
    )}

    {showCategories && categories.length > 0 && (
      <div class="mb-8 flex flex-wrap justify-center gap-2">
        <button
          class="category-filter px-4 py-2 rounded-full border border-primary/20 hover:bg-surface-bright transition-colors active"
          data-category="all"
        >
          All
        </button>
        {categories.map((category) => (
          <button
            class="category-filter px-4 py-2 rounded-full border border-primary/20 hover:bg-surface-bright transition-colors"
            data-category={category}
          >
            {category}
          </button>
        ))}
      </div>
    )}

    {layout === "grid" ? (
      <!-- Standard Grid Layout -->
      <div class={`grid grid-cols-1 ${columnClasses[columns]} gap-6 md:gap-4`} data-layout="grid">
        {images.map((image) => (
          <button
            class="gallery-item group relative overflow-hidden rounded-lg cursor-pointer aspect-[4/3] w-full text-left"
            data-category={image.category}
            data-image-id={image.id}
            type="button"
            aria-label={`View ${image.title || image.alt}`}
          >
            <img
              src={image.src}
              alt={image.alt}
              class="w-full h-full object-cover"
              style="transition: transform 300ms ease-out;"
              loading="lazy"
            />
            {(image.title || image.category) && (
              <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent opacity-0" style="transition: opacity 300ms ease-out;">
                <div class="absolute bottom-0 left-0 right-0 p-4 text-white">
                  {image.title && (
                    <h3 class="font-semibold text-lg mb-1">{image.title}</h3>
                  )}
                  {image.category && (
                    <span class="text-sm text-white/80">{image.category}</span>
                  )}
                </div>
              </div>
            )}
          </button>
        ))}
      </div>
    ) : (
      <!-- Bento Box Layout -->
      <div class="bento-grid grid grid-cols-4 md:grid-cols-8 gap-4 auto-rows-[200px]" data-layout="bento">
        {images.map((image, index) => {
          // When filtered, use uniform pattern (every 3 items = perfect row)
          // When showing all, use varied interesting pattern
          const uniformPattern = [
            "col-span-4 md:col-span-4 row-span-2", // 4 cols, 2 rows = 8 units
            "col-span-2 md:col-span-2 row-span-2", // 2 cols, 2 rows = 4 units  
            "col-span-2 md:col-span-2 row-span-2", // 2 cols, 2 rows = 4 units
          ];
          
          const variedPattern = [
            "col-span-4 md:col-span-4 row-span-2", // Large square
            "col-span-2 md:col-span-2 row-span-1", // Small
            "col-span-2 md:col-span-2 row-span-1", // Small
            "col-span-2 md:col-span-4 row-span-1", // Wide
            "col-span-2 md:col-span-2 row-span-2", // Tall
            "col-span-2 md:col-span-2 row-span-1", // Small
            "col-span-4 md:col-span-4 row-span-1", // Wide
            "col-span-2 md:col-span-2 row-span-1", // Small
            "col-span-2 md:col-span-2 row-span-2", // Tall
          ];
          
          // Use varied pattern initially (will switch to uniform when filtering via JS)
          const pattern = variedPattern[index % variedPattern.length];
          
          return (
            <button
              class={`gallery-item group relative overflow-hidden rounded-lg cursor-pointer w-full text-left ${pattern}`}
              data-category={image.category}
              data-image-id={image.id}
              data-index={index}
              type="button"
              aria-label={`View ${image.title || image.alt}`}
            >
              <img
                src={image.src}
                alt={image.alt}
                class="w-full h-full object-cover"
                style="transition: transform 300ms ease-out;"
                loading="lazy"
              />
              {(image.title || image.category) && (
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent opacity-0" style="transition: opacity 300ms ease-out;">
                  <div class="absolute bottom-0 left-0 right-0 p-4 text-white">
                    {image.title && (
                      <h3 class="font-semibold text-lg mb-1">{image.title}</h3>
                    )}
                    {image.category && (
                      <span class="text-sm text-white/80">{image.category}</span>
                    )}
                  </div>
                </div>
              )}
            </button>
          );
        })}
      </div>
    )}
  </div>
</section>

<!-- Lightbox Modal -->
<div
  id="lightbox"
  class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4 cursor-pointer"
  style="backdrop-filter: blur(8px); transition: opacity 300ms ease-out;"
>
  <button
    id="lightbox-prev"
    class="absolute left-4 text-white hover:text-white/70 transition-colors z-10 cursor-pointer"
    aria-label="Previous image"
  >
    <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M15 19l-7-7 7-7"
      />
    </svg>
  </button>

  <button
    id="lightbox-next"
    class="absolute right-4 text-white hover:text-white/70 transition-colors z-10 cursor-pointer"
    aria-label="Next image"
  >
    <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 5l7 7-7 7"
      />
    </svg>
  </button>

  <div class="max-w-5xl max-h-[90vh] w-full h-full flex items-center justify-center pointer-events-none">
    <img
      id="lightbox-image"
      src=""
      alt=""
      class="max-w-full max-h-full object-contain rounded-lg"
      style="opacity: 1;"
    />
  </div>

  <div id="lightbox-info" class="absolute bottom-4 left-0 right-0 text-center text-white pointer-events-none">
    <h3 id="lightbox-title" class="text-xl font-semibold mb-1"></h3>
    <p id="lightbox-category" class="text-sm text-white/70"></p>
  </div>
</div>

<script>
  // Uniform pattern for filtered views
  const uniformPattern = [
    "col-span-4 md:col-span-4 row-span-2",
    "col-span-2 md:col-span-2 row-span-2",
    "col-span-2 md:col-span-2 row-span-2",
  ];

  // Varied pattern for "all" view
  const variedPattern = [
    "col-span-4 md:col-span-4 row-span-2",
    "col-span-2 md:col-span-2 row-span-1",
    "col-span-2 md:col-span-2 row-span-1",
    "col-span-2 md:col-span-4 row-span-1",
    "col-span-2 md:col-span-2 row-span-2",
    "col-span-2 md:col-span-2 row-span-1",
    "col-span-4 md:col-span-4 row-span-1",
    "col-span-2 md:col-span-2 row-span-1",
    "col-span-2 md:col-span-2 row-span-2",
  ];

  // Category filter
  const categoryButtons = document.querySelectorAll('.category-filter');
  const galleryItems = document.querySelectorAll('.gallery-item');
  const galleryGrid = document.querySelector('[data-layout]');
  const currentLayout = galleryGrid?.getAttribute('data-layout') || 'grid';

  categoryButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const category = button.getAttribute('data-category');

      // Update active state
      categoryButtons.forEach((btn) => btn.classList.remove('active', 'bg-primary', 'text-on-primary'));
      button.classList.add('active', 'bg-primary', 'text-on-primary');

      // Choose pattern based on whether filtering
      const isFiltering = category !== 'all';
      let visibleIndex = 0;

      // Filter items and update bento layout classes
      galleryItems.forEach((item) => {
        const htmlItem = item as HTMLElement;
        const shouldShow = category === 'all' || item.getAttribute('data-category') === category;
        
        if (shouldShow) {
          htmlItem.style.display = '';
          // Update bento pattern classes (only for bento layout)
          if (currentLayout === 'bento') {
            const originalIndex = parseInt(htmlItem.getAttribute('data-index') || '0');
            const pattern = isFiltering 
              ? uniformPattern[visibleIndex % uniformPattern.length]
              : variedPattern[originalIndex % variedPattern.length];
            
            // Remove all possible span classes
            htmlItem.classList.remove(
              'col-span-2', 'col-span-4',
              'md:col-span-2', 'md:col-span-4',
              'row-span-1', 'row-span-2'
            );
            
            // Add new pattern classes
            pattern.split(' ').forEach(cls => htmlItem.classList.add(cls));
          }
          
          visibleIndex++;
        } else {
          htmlItem.style.display = 'none';
        }
      });
    });
  });

  // Lightbox functionality
  const lightbox = document.getElementById('lightbox') as HTMLElement;
  const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
  const lightboxTitle = document.getElementById('lightbox-title') as HTMLElement;
  const lightboxCategory = document.getElementById('lightbox-category') as HTMLElement;
  const lightboxPrev = document.getElementById('lightbox-prev') as HTMLElement;
  const lightboxNext = document.getElementById('lightbox-next') as HTMLElement;

  let currentImageIndex = 0;
  const visibleImages = () => Array.from(galleryItems).filter(
    (item) => (item as HTMLElement).style.display !== 'none'
  );
  const showLightbox = (index: number) => {
    const images = visibleImages();
    if (index < 0) index = images.length - 1;
    if (index >= images.length) index = 0;
    
    currentImageIndex = index;
    const item = images[index] as HTMLElement;
    const img = item.querySelector('img') as HTMLImageElement;
    
    lightboxImage.src = img.src;
    lightboxImage.alt = img.alt;
    
    const title = item.querySelector('h3')?.textContent || '';
    const category = item.querySelector('span')?.textContent || '';
    
    lightboxTitle.textContent = title;
    lightboxCategory.textContent = category;
    
    // Show and animate
    lightbox.classList.remove('hidden');
    lightbox.classList.add('flex');
    
    requestAnimationFrame(() => {
      lightbox.style.opacity = '1';
      lightboxImage.style.opacity = '1';
      lightboxImage.style.transform = 'scale(1)';
    });
    document.body.style.overflow = 'hidden';
  };

  const closeLightbox = () => {
    lightbox.style.opacity = '0';
    lightboxImage.style.opacity = '0';
    lightboxImage.style.transform = 'scale(0.95)';
    
    setTimeout(() => {
      lightbox.classList.add('hidden');
      lightbox.classList.remove('flex');
      lightbox.style.opacity = '1';
      document.body.style.overflow = '';
    }, 300);
  };

  galleryItems.forEach((item, index) => {
    item.addEventListener('click', () => {
      const images = visibleImages();
      const actualIndex = images.indexOf(item);
      showLightbox(actualIndex);
    });
  });

  lightboxPrev.addEventListener('click', () => showLightbox(currentImageIndex - 1));
  lightboxNext.addEventListener('click', () => showLightbox(currentImageIndex + 1));

  // Close on backdrop click
  lightbox.addEventListener('click', (e) => {
    if (e.target === lightbox) closeLightbox();
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (!lightbox.classList.contains('hidden')) {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') showLightbox(currentImageIndex - 1);
      if (e.key === 'ArrowRight') showLightbox(currentImageIndex + 1);
    }
  });
</script>

<style>
  .gallery-item:hover img {
    transform: scale(1.1);
  }

  .gallery-item:hover > div {
    opacity: 1;
  }

  .category-filter.active {
    background-color: var(--color-primary);
    color: var(--color-on-primary);
  }
</style>
